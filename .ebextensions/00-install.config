container_commands:
  01_install_instance_connect:
    command: |
      yum install -y ec2-instance-connect
  02_fetch_secrets:
    command: |
      # Fetch secrets from SSM and add to environment 
      DB_PASSWORD=$(aws ssm get-parameter --name "/boilerplate-dev/db-password" --with-decryption --query 'Parameter.Value' --output text --region eu-central-1) 
      API_KEY=$(aws ssm get-parameter --name "/boilerplate-dev/api-key" --with-decryption --query 'Parameter.Value' --output text --region eu-central-1) 
      MAIL_PASSWORD=$(aws ssm get-parameter --name "/boilerplate-dev/mail-password" --with-decryption --query 'Parameter.Value' --output text --region eu-central-1)
      
      # Export to deployment environment
      echo "DB_PASSWORD=$DB_PASSWORD">> /opt/elasticbeanstalk/deployment/env
      echo "API_KEY=$API_KEY">> /opt/elasticbeanstalk/deployment/env  
      echo "MAIL_PASSWORD=$MAIL_PASSWORD">> /opt/elasticbeanstalk/deployment/env
  03_install_dependancies:
    command: |
      npm ci
  04_run_migrations:
    command: |
      # Load environment variables safely
      while IFS='=' read -r key value; do
        if [[ $key && $value && ! $key =~ ^# ]]; then
          export "$key"="$value"
        fi
      done < /opt/elasticbeanstalk/deployment/env
      npm run migration:run
    leader_only: true